<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Solista</title>

    <link rel="icon" type="image/png" sizes="32x32" href="./assets/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./assets/favicon-16.png">
    <link rel="shortcut icon" href="./assets/favicon.ico">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <link rel="stylesheet" href="./styles/styles.css">
</head>

<body>
    <!-- HEADER -->
    <header id="floating-header-btn">
        <a href="index.html">
            <svg width="42" height="42" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <!-- Orbital ring -->
                <circle cx="50" cy="50" r="35" stroke="#8ab4ff" stroke-width="4" opacity="0.6" />

                <!-- Galaxy swirl -->
                <path d="M20 55 Q50 10 80 45" stroke="#00d4ff" stroke-width="3" fill="none" opacity="0.8" />
                <path d="M20 45 Q50 90 80 55" stroke="#b388ff" stroke-width="3" fill="none" opacity="0.8" />

                <!-- Musical note at center -->
                <path d="M50 30 V65 
             A8 8 0 1 0 50 65
             V30 Z" fill="#ffffff" />
                <circle cx="50" cy="70" r="7" fill="#ffffff" />

                <!-- Star dots -->
                <circle cx="25" cy="30" r="2" fill="#8ab4ff" />
                <circle cx="75" cy="70" r="2" fill="#b388ff" />
                <circle cx="70" cy="28" r="1.8" fill="#00d4ff" />
                <circle cx="32" cy="75" r="1.5" fill="#ffffff" />
            </svg>
        </a>
    </header>

    <!-- WORKSPACE -->
    <div class="workspace container-fluid">

        <!-- PIANO ROLL -->
        <div class="piano-roll-container">
            <div class="playing-line-wrapper" id="play_line">
                <div class="playing-line">&nbsp;</div>
            </div>
            <div class="roll-grid"></div>

            <div class="piano-roll" style="padding-left: 10%;">
                <svg id="pianoSvg" class="piano-svg"></svg>

                <div id="rollPlaceholder" class="d-flex justify-content-center align-items-center h-100"
                    style="color:var(--text-soft); font-size:1.2rem;">
                    Carga un archivo MusicXML (.musicxml) para comenzar…
                </div>
            </div>
        </div>


        <!-- PANEL DERECHO -->
        <aside class="panel">

            <h5 class="mb-3">Archivo .musicmxl</h5>
            <input type="file" class="form-control" accept=".musicxml,.xml" id="mxlInput">

            <div class="mt-3" id="fileInfo" style="color:var(--text-soft); font-size:0.9rem;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                Ningún archivo cargado.
            </div>


            <hr class="my-4" style="border-color:rgba(255,255,255,0.1);">

            <h5 class="mb-2">Selecciona tu voz</h5>
            <select id="voiceSelect" class="form-select">
                <option value="soprano">Soprano</option>
                <option value="alto">Alto</option>
                <option value="tenor">Tenor</option>
                <option value="bajo">Bajo</option>
            </select>

            <div class="form-check form-switch mt-3 px-1"
                style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px 14px; padding-left: 20% !important;">
                <input class="form-check-input" type="checkbox" id="soloVoiceToggle" style="cursor:pointer;">
                <label class="form-check-label ms-1" for="soloVoiceToggle"
                    style="cursor: pointer; color:var(--text-soft); font-size:0.9rem;">
                    Modo Solista
                </label>
            </div>


            <hr class="my-4" style="border-color:rgba(255,255,255,0.1);">

            <h5 class="mb-2">Tempo</h5>

            <div class="d-flex gap-2 justify-content-center align-items-center">
                <input id="tempoInput" type="number" value="120" min="20" max="300"
                    style="border-radius: 8px; outline: none; border: none; padding: 6px 12px;"> BPM
                <button id="tempoButton" class="btn btn-outline-light w-100">Cambiar Tempo</button>
            </div>

            <hr class="my-4" style="border-color:rgba(255,255,255,0.1);">

            <h5 class="mb-2">Controles</h5>
            <div class="d-flex gap-2">
                <button class="btn btn-neon w-100"><i class="bi bi-mic"></i> Mic</button>
                <button id="playBtn" class="btn btn-outline-light w-100"><i class="bi bi-play-fill"></i></button>
                <button id="stopBtn" class="btn btn-outline-light w-100"><i class="bi bi-stop-fill"></i></button>
                <button id="restartBtn" class="btn btn-outline-light w-100"><i
                        class="bi bi-arrow-counterclockwise"></i></button>
            </div>

            <hr class="my-4" style="border-color:rgba(255,255,255,0.1);">

            <h5 class="mb-2">Análisis en vivo</h5>
            <div class="p-3 rounded" style="background: rgba(255,255,255,0.04);">
                <p class="m-0" style="color:var(--text-soft);">• Pitch: <span id="pitchData">--</span></p>
                <p class="m-0" style="color:var(--text-soft);">• Desviación: <span id="diffData">--</span></p>
                <p class="m-0" style="color:var(--text-soft);">• Nota objetivo: <span id="targetNote">--</span></p>
            </div>

        </aside>

    </div>

    <!-- FOOTER -->
    <footer class="text-center">
        <small>Solista © 2025 — Construido para cantantes que vienen de otra galaxia ✦</small>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script type="module">
        import { loadMusicXML, pitchToMidi } from "./js/mxlParser.js";
        import { renderPianoRoll } from './js/pianoRoll.js';
        import { initPianoRollPlayer, playSong, stopSong, restartSong, applyTempo, setSoloMode } from "./js/pianoRollPlayer.js";


        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById("playBtn").onclick = playSong;
            document.getElementById("stopBtn").onclick = stopSong;
            document.getElementById("restartBtn").onclick = restartSong;
            document.getElementById("tempoButton").onclick = applyTempo;

            document.getElementById("soloVoiceToggle").onchange = () => {
                const isSolo = document.getElementById("soloVoiceToggle").checked;
                const selectedVoice = Number(document.getElementById("voiceSelect").value);

                setSoloMode(isSolo, selectedVoice);
            };

            const voiceSelect = document.getElementById("voiceSelect");

            voiceSelect.addEventListener("change", () => {
                const selected = Number(document.getElementById("voiceSelect").value);
                renderPianoRoll(window.__ALL_NOTES__, selected);
                const isSolo = document.getElementById("soloVoiceToggle").checked;
                setSoloMode(isSolo, selected);
            });


            document.getElementById("mxlInput").onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                document.getElementById("fileInfo").innerText = "Partitura cargada: " + file.name;

                try {
                    const score = await loadMusicXML(file);
                    console.log("Partitura:", score);

                    if (!score || !score.parts || !Array.isArray(score.parts) || score.parts.length === 0) return;

                    const totalVoices = score.parts.length ?? 0;

                    const info = document.getElementById("rollPlaceholder")
                    if (info) info.style.color = 'transparent';

                    const line = document.getElementById("play_line");
                    console.log(line)
                    if (line) line.style.display = "flex";

                    // === 1. Generar selector dinámico ===
                    const select = document.getElementById("voiceSelect");
                    select.innerHTML = ""; // limpiar

                    score.parts.forEach((part, i) => {
                        const option = document.createElement("option");
                        option.value = i;
                        option.textContent = part.name ?? `Voz ${i + 1}`;
                        select.appendChild(option);
                    });

                    // === 2. Combinar TODAS las voces en un único arreglo ===
                    const flatten = score.parts.flatMap((part, i) =>
                        part.notes.map(n => ({
                            ...n,
                            voice: i, // importante para colorear
                            midi: n.midi ?? pitchToMidi(n.step, n.alter, n.octave)
                        }))
                    );

                    // Guarda las notas globalmente para re-render según la voz seleccionada
                    window.__ALL_NOTES__ = flatten;

                    renderPianoRoll(flatten, select.value);

                    // === 3. Re-render cuando cambie la voz seleccionada ===
                    select.onchange = () => {
                        renderPianoRoll(window.__ALL_NOTES__, select.value);
                    };

                    // Inicializar sistema de reproducción + scroll
                    // Filtrar solo notas válidas
                    const validNotes = flatten.filter(n =>
                        n &&
                        typeof n.midi === "number" &&
                        !isNaN(n.midi) &&
                        typeof n.time === "number" &&
                        typeof n.duration === "number"
                    );


                    const svg = document.getElementById("pianoSvg");
                    const container = document.querySelector(".piano-roll");
                    initPianoRollPlayer(validNotes, svg, container, totalVoices);


                } catch (err) {
                    console.error("Error:", err);
                    document.getElementById("fileInfo").innerText = "Error cargando el archivo";
                }
            };

        })
    </script>

</body>

</html>